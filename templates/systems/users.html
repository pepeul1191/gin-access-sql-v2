{{define "systems/users"}}
  {{template "dashboard_header.html" .}}
  <!-- CONTENIDO PRINCIPAL -->
  <div class="container-fluid py-4">
    <h3 class="mb-4">
      <a class="return-nav" href="/systems"><i class="fa fa-cogs me-2"></i>Gestión de Sistemas</a>
      / Usuarios del Sistema
    </h3>

    {{if .message.Type}}
    <div class="alert alert-{{.message.Type}}">
        {{.message.Content}}
    </div>
    {{end}}
    <!-- Filtros de Búsqueda -->
    <div class="card mb-4">
      <div class="card-header">
        <h6 class="mb-0">
          <i class="fa fa-filter me-2"></i>
          Filtros de Búsqueda
        </h6>
      </div>
      <div class="card-body">
        <form method="GET" action="/systems/{{.systemID}}/users">
          <input type="hidden" name="per_page" value="{{.perPage}}">
          <div class="row mb-3 align-items-end">
            <div class="col-md-3">
              <label for="username" class="form-label">Buscar por usuario</label>
              <div class="input-group">
                <input type="text" id="username" name="username" class="form-control" placeholder="Nombre..." value="{{.usernameQuery}}">
              </div>
            </div>
            <div class="col-md-3">
              <label for="email" class="form-label">Buscar por correo</label>
              <div class="input-group">
                <input type="text" id="email" name="email" class="form-control" placeholder="Descripción..." value="{{.emailQuery}}">
              </div>
            </div>
            <div class="col-md-3">
              <label for="status" class="form-label">Asociado al sistema</label>
              <select id="status" name="association_status" class="form-select">
                <option value="">Todos los estados</option>
                <option value="1" {{if eq .statusQuery "active"}}selected{{end}}>Asociado</option>
                <option value="0" {{if eq .statusQuery "inactive"}}selected{{end}}>No Asociado</option>
              </select>
            </div>
            <div class="col-md-3">
              <div class="input-group">
                <button type="submit" class="btn btn-primary">
                  <i class="fa fa-search"></i> Buscar
                </button>
                <a href="/systems/{{.systemID}}/users" class="btn btn-secondary ms-2">
                  <i class="fa fa-refresh"></i> Limpiar
                </a>
              </div>
            </div>
          </div>
        </form>        
      </div>
    </div>

    <!-- Listado de Sistemas -->
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0">
          <i class="fa fa-list me-2"></i>
          Listado de Usuarios
        </h6>
      </div>
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div class="d-flex align-items-center me-3">
            <label for="rows-per-page" class="form-label mb-0 me-2">Filas por página:</label>
            <form method="GET" id="per_page_form">
              <input type="hidden" name="name" value="{{.nameQuery}}">
              <input type="hidden" name="description" value="{{.descriptionQuery}}">
              <input type="hidden" name="association_status" value="{{.statusQuery}}">
              <select name="per_page" class="form-select" style="width: 120px;" onchange="this.form.submit()">
                <option value="5" {{if eq .perPage 5}}selected{{end}}>5</option>
                <option value="10" {{if eq .perPage 10}}selected{{end}}>10</option>
                <option value="25" {{if eq .perPage 25}}selected{{end}}>25</option>
                <option value="50" {{if eq .perPage 50}}selected{{end}}>50</option>
                <option value="100" {{if eq .perPage 100}}selected{{end}}>100</option>
              </select>
            </form>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-success">
              <i class="fa fa-check"></i> Guardar Cambios
            </button>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>Usuario</th>
                <th>Correo</th>
                <th>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="select-all" name="select_all">
                    <label class="form-check-label" for="select-all">Asociado</label>
                  </div>
                </th>
                <th class="text-end">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {{range .users}}
              <tr>
                <td>{{.Username}}</td>
                <td>{{.Email}}</td>
                <td>
                  <div class="form-check">
                    <input class="form-check-input user-checkbox" 
                          type="checkbox" 
                          value="{{.ID}}"
                          {{if .AssociationStatus}}checked{{end}}>
                  </div>
                </td>
                <td class="text-end btn-group-sm">
                  <a href="/systems/{{$.systemID}}/users/{{.ID}}" class="btn btn-outline-primary">
                    <i class="fa fa-list"></i> Gestionar Accesos
                  </a>
                </td>
              </tr>
              {{else}}
              <tr>
                <td colspan="3" class="text-center">No users found.</td>
              </tr>
              {{end}}
            </tbody>
            <tfoot>
              <tr>
                <td colspan="5">
                  <div class="d-flex justify-content-between align-items-center mt-3">
                    <div class="text-left">
                      Página {{.page}} de {{.totalPages}} - Mostrando registros {{.startRecord}} - {{.endRecord}} de un total de {{.totalUsers}}
                    </div>

                    <nav aria-label="Page navigation">
                      <ul class="pagination mb-0">
                        <li class="page-item {{if eq .page 1}}disabled{{end}}">
                          <a class="page-link" href="/systems/{{.systemID}}/users?page=1&per_page={{.perPage}}&username={{.usernameQuery}}&email={{.emailQuery}}&status={{.statusQuery}}" aria-label="First">
                            <i class="fa fa-angle-double-left"></i> Primero
                          </a>
                        </li>

                        <li class="page-item {{if eq .page 1}}disabled{{end}}">
                          <a class="page-link" href="/systems/{{.systemID}}/users?page={{sub .page 1}}&per_page={{.perPage}}&username={{.usernameQuery}}&email={{.emailQuery}}&status={{.statusQuery}}" aria-label="Previous">
                            <i class="fa fa-angle-left"></i> Anterior
                          </a>
                        </li>

                        <li class="page-item {{if eq .page .totalPages}}disabled{{end}}">
                          <a class="page-link" href="/systems/{{.systemID}}/users?page={{add .page 1}}&per_page={{.perPage}}&username={{.usernameQuery}}&email={{.emailQuery}}&status={{.statusQuery}}" aria-label="Next">
                            Siguiente <i class="fa fa-angle-right"></i>
                          </a>
                        </li>

                        <li class="page-item {{if eq .page .totalPages}}disabled{{end}}">
                          <a class="page-link" href="/systems/{{.systemID}}/users?page={{.totalPages}}&per_page={{.perPage}}&username={{.usernameQuery}}&email={{.emailQuery}}&status={{.statusQuery}}" aria-label="Last">
                            Último <i class="fa fa-angle-double-right"></i>
                          </a>
                        </li>
                      </ul>
                    </nav>
                  </div>
                </td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  {{template "dashboard_footer.html" .}}
{{end}}
